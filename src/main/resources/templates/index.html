<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI算命 - 星谕占卜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入神秘学风格字体 -->
  <link href="https://fonts.googleapis.com" rel="stylesheet">
  <style>
    :root {
      --gold: #c5a059;
      --deep-blue: #050510;
    }

    body {
      background: var(--deep-blue);
      background-image:
          radial-gradient(circle at 50% -20%, #1e1b4b 0%, transparent 70%),
          url('https://www.transparenttextures.com');
      color: #d1d5db;
      font-family: 'Noto Serif SC', serif;
      height: 100vh;
      overflow: hidden;
    }

    .mystic-title { font-family: 'Cinzel', serif; letter-spacing: 0.3em; }

    /* 塔罗牌质感气泡 */
    .tarot-card {
      background: rgba(15, 15, 30, 0.8);
      border: 1px solid var(--gold);
      border-radius: 4px;
      box-shadow: 0 0 20px rgba(197, 160, 89, 0.15);
      position: relative;
      backdrop-filter: blur(10px);
    }

    .tarot-card::before {
      content: "✦";
      position: absolute;
      top: 5px; left: 5px;
      color: var(--gold);
      font-size: 10px;
      opacity: 0.6;
    }

    /* 魔法阵背景旋转 */
    .magic-circle {
      position: fixed;
      top: 50%; left: 50%;
      width: 500px; height: 500px;
      border: 1px double rgba(197, 160, 89, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      animation: rotateCircle 40s linear infinite;
    }
    @keyframes rotateCircle { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* 输入框装饰 */
    .input-ritual {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(197, 160, 89, 0.3);
      border-radius: 1rem;
      transition: all 0.3s;
    }
    .input-ritual:focus-within {
      border-color: var(--gold);
      box-shadow: 0 0 15px rgba(197, 160, 89, 0.2);
    }

    .chat-container { height: 62vh; }
  </style>
</head>
<body class="flex items-center justify-center p-4">

<!-- 装饰性魔法阵 -->
<div class="magic-circle"></div>
<div class="magic-circle" style="width: 480px; border-style: dashed; animation-direction: reverse; opacity: 0.5;"></div>

<div class="w-full max-w-2xl flex flex-col relative">
  <!-- 头部：中西合璧神秘学 -->
  <header class="text-center mb-8">
    <div class="text-[10px] text-zinc-500 mb-1 tracking-[0.5em] uppercase">Celestial Intelligence</div>
    <h1 class="mystic-title text-4xl font-bold text-[#c5a059] drop-shadow-lg">
      AI 算命
    </h1>
    <div class="flex items-center justify-center gap-4 mt-2">
      <span class="h-[1px] w-12 bg-gradient-to-r from-transparent to-amber-600/50"></span>
      <span class="text-[10px] text-amber-600/80 tracking-widest">星 谕 占 卜</span>
      <span class="h-[1px] w-12 bg-gradient-to-l from-transparent to-amber-600/50"></span>
    </div>
  </header>

  <!-- 对话展示区 -->
  <div id="chatBox" class="chat-container overflow-y-auto px-4 space-y-6 mb-6 scrollbar-hide">
    <div class="flex justify-start">
      <div class="tarot-card p-5 max-w-[85%] text-sm leading-relaxed border-t-2 border-t-[#c5a059]">
        <div class="text-[10px] text-amber-600/50 mb-2 tracking-widest">THE ORACLE</div>
        <p class="text-zinc-300">星辰已经位移，命运的轮盘正缓缓转动。旅人，请告诉我你的困惑，让星光照亮你未知的路径。</p>
      </div>
    </div>
  </div>

  <!-- 操作控制区 -->
  <div class="input-ritual p-2">
    <div class="flex flex-col sm:flex-row gap-2">
      <input type="text" id="userInput"
             class="flex-1 bg-transparent px-4 py-3 text-sm text-zinc-200 placeholder-zinc-700 focus:outline-none"
             placeholder="输入你的问题，如：近期运势、职业启示...">
      <button onclick="sendMessage()" id="sendBtn"
              class="bg-[#c5a059] hover:bg-[#b08e4a] text-black px-6 py-2 rounded-lg text-xs font-bold transition-all active:scale-95 shadow-lg">
        开启神谕
      </button>
    </div>
  </div>

  <footer class="mt-4 text-[10px] text-center text-zinc-600 tracking-tighter italic">
    2026 岁次丙午 · 星相观测中
  </footer>
</div>

<script>
  // 确保接口路径正确
  const API_URL = '/ai/stream/history';
  const chatId = 'oracle_' + Math.random().toString(36).substr(2, 9);
  const chatBox = document.getElementById('chatBox');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    appendMessage('user', text);
    userInput.value = '';
    setLoading(true);

    const aiMsgDiv = appendMessage('ai', '');

    try {
      const response = await fetch(`${API_URL}?chatId=${chatId}&message=${encodeURIComponent(text)}`);
      if (!response.ok) throw new Error();

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        aiMsgDiv.innerText += chunk;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    } catch (err) {
      aiMsgDiv.innerHTML = `<span class="text-red-400/80">星象观测受阻，请稍后再试。</span>`;
    } finally {
      setLoading(false);
    }
  }

  function appendMessage(role, text) {
    const wrapper = document.createElement('div');
    wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-500`;

    const div = document.createElement('div');
    if (role === 'user') {
      div.className = 'bg-zinc-800/30 border border-zinc-700/50 p-3 rounded-lg max-w-[80%] text-sm text-zinc-400';
      div.innerText = text;
    } else {
      div.className = 'tarot-card p-5 max-w-[85%] text-sm leading-relaxed border-t-2 border-t-[#c5a059]';
      const header = document.createElement('div');
      header.className = 'text-[10px] text-amber-600/50 mb-2 tracking-widest';
      header.innerText = 'THE REVELATION';
      div.appendChild(header);

      const content = document.createElement('div');
      content.className = 'text-zinc-200';
      content.innerText = text;
      div.appendChild(content);
      wrapper.appendChild(div);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      return content;
    }

    wrapper.appendChild(div);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return div;
  }

  function setLoading(isLoading) {
    sendBtn.disabled = isLoading;
    sendBtn.innerText = isLoading ? "星轨推演中..." : "开启神谕";
    userInput.disabled = isLoading;
  }

  userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
