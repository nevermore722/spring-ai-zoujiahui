<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—æ·± - ä½ çš„ä¸“å±ç”·å‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; }
        .bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('/boy.jfif') center/cover no-repeat; z-index: -2; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); z-index: -1; }
        .chat-bubble { position: relative; max-width: 75%; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
        .bubble-ai { background: white; color: #111; margin-left: 12px; border-radius: 4px 12px 12px 12px; }
        .bubble-user { background: #95ec69; color: #111; margin-right: 12px; border-radius: 12px 4px 12px 12px; }
        .bubble-ai::before { content: ""; position: absolute; left: -8px; top: 10px; border-width: 4px 8px 4px 0; border-style: solid; border-color: transparent white transparent transparent; }
        .bubble-user::after { content: ""; position: absolute; right: -8px; top: 10px; border-width: 4px 0 4px 8px; border-style: solid; border-color: transparent transparent transparent #95ec69; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .typing-dot { width: 4px; height: 4px; background: #999; border-radius: 50%; display: inline-block; animation: blink 1.4s infinite both; margin: 0 1px; }
        @keyframes blink { 0%, 100% { opacity: .2; } 20% { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col bg-gray-100">
<div class="bg-container"></div>
<div class="bg-overlay"></div>

<header class="flex items-center justify-between px-4 py-3 bg-white/80 backdrop-blur border-b border-gray-200 sticky top-0 z-10">
    <a href="index.html" class="text-gray-600 text-lg">ã€ˆ</a>
    <div class="text-center">
        <div class="font-bold text-gray-800">æ—æ·± ğŸ‘”</div>
        <div class="text-[10px] text-green-500">â— å¯¹æ–¹æ­£åœ¨æƒ³ä½ </div>
    </div>
    <div class="w-6"></div>
</header>

<main id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar"></main>

<footer class="bg-[#f7f7f7] border-t border-gray-200 p-3 pb-8">
    <div class="flex items-end gap-3">
        <textarea id="userInput" rows="1" class="flex-1 bg-white border-none rounded-lg p-2 text-sm focus:ring-1 focus:ring-green-500 resize-none overflow-hidden" placeholder="æƒ³å¯¹ä»–è¯´ä»€ä¹ˆ..."></textarea>
        <button id="actionBtn" onclick="handleAction()" class="bg-[#07c160] text-white px-4 py-2 rounded-lg text-sm font-medium transition-all active:opacity-70">
            ä½ å…ˆè¯´
        </button>
    </div>
</footer>

<script>
    let hasStarted = false; // çŠ¶æ€é”ï¼šä¸€æ—¦äº’åŠ¨è¿‡å°±è®¾ä¸º true
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const actionBtn = document.getElementById('actionBtn');
    const API_URL = '/ai/app/boyfriend';
    const chatId = 'boy_' + Math.random().toString(36).substr(2, 9);

    // ç›‘å¬è¾“å…¥ï¼šæœªå¼€å¯å¯¹è¯ä¸”æ— å­—æ˜¾ç¤ºâ€œä½ å…ˆè¯´â€ï¼Œå¦åˆ™æ˜¾ç¤ºâ€œå‘é€â€
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';

        if (hasStarted || this.value.trim().length > 0) {
            actionBtn.innerText = "å‘é€";
        } else {
            actionBtn.innerText = "ä½ å…ˆè¯´";
        }
    });

    async function handleAction() {
        const text = userInput.value.trim();

        // åªè¦ç‚¹å‡»ï¼Œå°±é”å®šçŠ¶æ€
        const isFirstGreet = (actionBtn.innerText === "ä½ å…ˆè¯´");
        hasStarted = true;

        if (isFirstGreet && text === "") {
            // è¯·æ±‚ AI ä¸»åŠ¨å‘èµ·å¯¹è¯
            await sendRequest("ä½ ç°åœ¨æ˜¯æˆ‘çš„ç”·æœ‹å‹æ—æ·±ï¼Œè¯·ä¸»åŠ¨è·Ÿæˆ‘æ‰“ä¸ªæ‹›å‘¼ï¼Œè¯´ç‚¹æ’©äººæˆ–è€…å…³æ€€çš„è¯ã€‚");
        } else if (text !== "") {
            // ç”¨æˆ·å‘é€æ¶ˆæ¯
            appendMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto';
            await sendRequest(text);
        }
    }

    async function sendRequest(message) {
        const aiWrapper = appendMessage('ai', '');
        const contentDiv = aiWrapper.querySelector('.content');
        contentDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot" style="animation-delay: 0.2s"></span><span class="typing-dot" style="animation-delay: 0.4s"></span>';

        try {
            // æ‹¼æ¥å‚æ•°ï¼šåŒ…å« chatId å’Œ message
            const url = `${API_URL}?chatId=${chatId}&message=${encodeURIComponent(message)}`;
            const response = await fetch(url);

            if (!response.ok) throw new Error();

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            contentDiv.innerText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                contentDiv.innerText += decoder.decode(value);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        } catch (err) {
            contentDiv.innerHTML = '<span class="text-red-500 text-[10px]">æ—æ·±å»å¿™äº†ï¼Œç¨åå†è¯•</span>';
        }
    }

    function appendMessage(role, text) {
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-4 items-start`;

        const avatar = document.createElement('img');
        avatar.className = `w-10 h-10 rounded-md object-cover flex-shrink-0`;
        // å¤´åƒè·¯å¾„ä¿®æ­£
        avatar.src = role === 'ai' ? '/boy.jfif' : 'https://api.dicebear.com';

        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${role === 'ai' ? 'bubble-ai' : 'bubble-user'}`;
        const content = document.createElement('div');
        content.className = 'content';
        content.innerText = text;
        bubble.appendChild(content);

        if (role === 'ai') {
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
        } else {
            wrapper.appendChild(bubble);
            wrapper.appendChild(avatar); // ç”¨æˆ·è¯´è¯ä¹Ÿæ˜¾ç¤ºå¤´åƒ
        }
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
        return wrapper;
    }
</script>
</body>
</html>