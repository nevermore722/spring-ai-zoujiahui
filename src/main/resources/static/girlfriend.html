<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘æ± - ä½ çš„æ¸©æŸ”å¥³å‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { height: 100svh; margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; }
        /* èƒŒæ™¯ï¼šæ¢¦å¹»ç²‰ç´«æ¸å˜ */
        .bg-glass {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
            z-index: -2;
        }
        .bg-decoration {
            position: fixed; top: -10%; right: -10%; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,182,193,0.2) 0%, transparent 70%);
            filter: blur(50px); z-index: -1;
        }
        /* å¾®ä¿¡æ°”æ³¡æ ·å¼ */
        .chat-bubble { position: relative; max-width: 78%; padding: 12px 16px; font-size: 15px; line-height: 1.6; }
        .bubble-ai { background: #ffffff; color: #333; margin-left: 10px; border-radius: 4px 16px 16px 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .bubble-user { background: #fee2e2; color: #4b1a1a; margin-right: 10px; border-radius: 16px 4px 16px 16px; }

        /* æ‰“å­—åŠ¨ç”» */
        .typing-dot { width: 4px; height: 4px; background: #fca5a5; border-radius: 50%; display: inline-block; animation: blink 1.4s infinite both; margin: 0 1px; }
        @keyframes blink { 0%, 100% { opacity: .2; } 20% { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">
<div class="bg-glass"></div>
<div class="bg-decoration"></div>

<header class="flex items-center justify-between px-4 py-4 bg-white/60 backdrop-blur-md border-b border-pink-100 sticky top-0 z-10">
    <a href="/" class="text-pink-400 text-xl">ã€ˆ</a>
    <div class="text-center">
        <div class="font-bold text-gray-800 tracking-wide">äº‘æ± ğŸŒ¸</div>
        <div class="text-[10px] text-pink-400 animate-pulse">â— æ­£åœ¨æƒ³ä½ ...</div>
    </div>
    <div class="w-6"></div>
</header>

<main id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar pb-10"></main>

<footer class="bg-white/80 backdrop-blur-lg border-t border-pink-50 p-4 pb-8">
    <div class="flex items-end gap-3 max-w-3xl mx-auto">
            <textarea id="userInput" rows="1"
                      class="flex-1 bg-gray-50 border-none rounded-2xl p-3 text-sm focus:ring-1 focus:ring-pink-200 resize-none max-h-32"
                      placeholder="è·Ÿäº‘æ±è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
        <button id="actionBtn" onclick="handleAction()"
                class="bg-pink-400 hover:bg-pink-500 text-white px-6 py-2.5 rounded-full text-sm font-medium transition-all active:scale-95 shadow-md shadow-pink-100">
            å”¤é†’å¥¹
        </button>
    </div>
</footer>

<script>
    let interactionLocked = false; // çŠ¶æ€é”
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const actionBtn = document.getElementById('actionBtn');
    const API_URL = '/ai/app/girlfriend';
    const chatId = 'girl_' + Math.random().toString(36).substr(2, 9);

    // ç›‘å¬è¾“å…¥é€»è¾‘ï¼šäº’åŠ¨åæ°¸è¿œæ˜¾ç¤ºâ€œå‘é€â€
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';

        if (interactionLocked || this.value.trim().length > 0) {
            actionBtn.innerText = "å‘é€";
        } else {
            actionBtn.innerText = "å”¤é†’å¥¹";
        }
    });

    async function handleAction() {
        const text = userInput.value.trim();
        const currentBtnText = actionBtn.innerText;

        // åªè¦ç‚¹å‡»ä¸€æ¬¡ï¼Œæ°¸ä¹…é”å®šçŠ¶æ€
        interactionLocked = true;
        actionBtn.innerText = "å‘é€";

        if (currentBtnText === "å”¤é†’å¥¹" && text === "") {
            // AI ä¸»åŠ¨å‘èµ·
            await sendRequest("äº‘æ±ï¼Œä½œä¸ºæˆ‘çš„å¥³æœ‹å‹ï¼Œè¯·æ¸©æŸ”åœ°è·Ÿæˆ‘è¯´å¥è¯å§ã€‚");
        } else if (text !== "") {
            // ç”¨æˆ·å‘é€
            appendMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto';
            await sendRequest(text);
        }
    }

    async function sendRequest(msg) {
        const wrapper = appendMessage('ai', '');
        const contentDiv = wrapper.querySelector('.content');
        contentDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot" style="animation-delay:0.2s"></span><span class="typing-dot" style="animation-delay:0.4s"></span>';

        try {
            const url = `${API_URL}?chatId=${chatId}&message=${encodeURIComponent(msg)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error();

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            contentDiv.innerText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                contentDiv.innerText += decoder.decode(value);
                chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            }
        } catch (err) {
            contentDiv.innerHTML = '<span class="text-pink-300 text-xs italic">äº‘æ±æ­£åœ¨åˆç¡ï¼Œç¨åå†æ‰¾å¥¹å§~</span>';
        }
    }

    function appendMessage(role, text) {
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-2 items-start`;

        const avatar = document.createElement('img');
        avatar.className = `w-10 h-10 rounded-full object-cover flex-shrink-0 border-2 border-white shadow-sm`;
        // å¤´åƒè·¯å¾„ï¼šAIæ˜¯å¥³ç”Ÿï¼Œç”¨æˆ·æ˜¯ç”·ç”Ÿ
        avatar.src = role === 'ai' ? '/girl.jfif' : '/boy.jfif';

        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${role === 'ai' ? 'bubble-ai' : 'bubble-user'}`;

        const content = document.createElement('div');
        content.className = 'content';
        content.innerText = text;

        bubble.appendChild(content);
        if (role === 'ai') {
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
        } else {
            // ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³è¾¹
            wrapper.appendChild(bubble);
            wrapper.appendChild(avatar);
        }

        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
        return wrapper;
    }
</script>
</body>
</html>